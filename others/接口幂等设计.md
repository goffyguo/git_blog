## 什么是幂等

幂等原先是数学中的一个概念，表示进行1次变换和进行N次变换产生的效果相同。

当在接口设计中讨论幂等时一般是在说：以相同的请求调用这个接口一次和调用这个接口多次，对系统产生的影响是相同的。如果一个接口满足这个特性，那么我们就说这个接口是一个幂等接口。

> 这里顺带学习下幂等和防止重复提交的区别
>
> 防止重复提交更多是不让用户发起多次一样的请求。比如说用户在线购买下单时点了提交按钮，但是由于网络原因响应很慢，此时用户比较心急多次惦记了订单提交按钮。
>
> 这种情况就可能操作多次下单。一般防止重复提交的方案有：将订单按钮置灰，跳转到结果页等，主要还是从客户端的角度来解决这个问题。

> 幂等更多的是在重复请求已经发生，或是在无法避免的情况下，采取一定的技术手段让这些重复请求不给系统带来副作用。

## 什么情况下需要幂等

并不是所有接口都需要保证幂等。以相同的请求调用这个接口一次或多次，需要给调用房返回一致的结果时，就要考虑将这个接口设计成幂等接口。

## 实现幂等的方案

设计幂等接口时重点关注新增接口和更新接口，因为查询和删除操作天生是幂等的（根据id查询和id删除多次对系统的影响是一致的）主要说关于新增和更新接口

### 唯一索引

使用唯一索引可以避免脏数据的添加，当插入重复数据时数据库会爆抛出异常，保证了数据的唯一性

### 乐观锁

这里的乐观锁指的是用乐观锁的原理去实现，为数据库增加一个version字段，当数据需更新的时候，先去数据库里获取此时的version版本号，SQL这么写：

```sql
select version from tablename where id = xxx
```

然后在更新数据时首先与版本号做对比，如果不相等说明已经有其他的请求去更新数据了，提示更新失败。SQL这么写：

```sql
update tablename set count=count+1,version=version+1 where version=#{version}
```

### 悲观锁

乐观锁可以实现的往往用悲观锁也可以实现，在获取数据时进行加锁，当同时有多个重复请求时其他请求都无法进行操作

### 分布式锁

幂等的本质是分布式锁的问题，分布式锁正常可以通过Redis或者Zookeeper实现。在分布式环境下，锁定全局唯一资源，使请求串行化，实现表现为互斥锁，防止重复，解决幂等。

### token 机制

token 的机制是每一次操作生成一个唯一性的凭证，也就是token。一个token在操作的每一个阶段只有一次执行权，一旦执行权成功则保存执行结果。对重复的请求，返回同一个结果。

### 状态机幂等

很多业务表，都是有状态的，比如转账流水表，就会有0-待处理，1-处理中、2-成功、3-失败等状态。转账流水更新的时候，都会涉及流水状态更新，即涉及状态机。可以利用状态机实现幂等。

比如转账成功后，把处理中的转账流水更新为成功状态，SQL这么写：

```sql
update transfr_flow set status=2 where biz_seq=‘666’ and status=1;
```

1. 第一条请求来时，bizSeq流水号是666，该流水的状态是处理中，值是1，要更新为2-成功的状态，所以该update语句会正常执行，SQL执行的结果的影响行数是1，流水状态最后变成2。
2. 第二条请求也过来了，如果它的流水号还是666，因为该流水状态已经是2-成功的状态了，所以SQL执行失败，不会再处理业务逻辑，接口直接返回成功。

伪代码如下：

```java
Rsp idempotentTransfer（Request req）{
   String bizSeq = req.getBizSeq();
   int rows= "update transfr_flow set status=2 where biz_seq=#{bizSeq} and status=2;"
   if(rows==1){
      log.info(“更新成功,可以处理该请求”);
      // 其他业务逻辑处理
      return rsp;
   }else if(rows==0){
      log.info(“更新不成功，不处理该请求”);
      // 不处理，直接返回
      return rsp;
   }
   
   log.warn("数据异常")
   return rsp：
}
```

